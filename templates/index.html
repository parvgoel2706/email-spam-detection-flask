<!-- index.html -->
<!doctype html>
<html lang="en">
  <head>
    <title>SpamShield — Email Spam Classifier</title>
    <link
      rel="shortcut icon"
      href="{{ url_for('static', filename='images/favicon.png') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='index.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/css/all.min.css"
    />
  </head>

  <body>
    <!-- ======================== HEADER ======================== -->
    <header class="header_section">
      <div class="header-inner">
        <a class="navbar-brand" href="/index"><span>SpamShield</span></a>
        <ul class="navbar-nav">
          <li>
            <a class="nav-link" href="/"
              ><i class="fa-solid fa-house"></i> Home</a
            >
          </li>
          <li>
            <a class="nav-link" href="/about"
              ><i class="fa-solid fa-circle-info"></i> About</a
            >
          </li>
          <li>
            <a class="nav-link" href="/logout"
              ><i class="fa-solid fa-right-from-bracket"></i> Log Out</a
            >
          </li>
          <li>
            <button id="theme-toggle" class="theme-btn" title="Toggle theme">
              <i class="fas fa-sun" id="sun-icon"></i>
              <i class="fas fa-moon" id="moon-icon"></i>
            </button>
          </li>
        </ul>
      </div>
    </header>

    <!-- ======================== MAIN ======================== -->
    <main class="classifier-wrapper">
      <div class="page-title-block">
        <h1 class="page-title">Email Spam <span>Classifier</span></h1>
        <p class="page-sub">
          Paste your email content below — our AI will detect spam instantly
        </p>
      </div>

      <div class="form-card">
        <form id="prediction-form">
          <div class="textarea-wrap">
            <textarea
              id="message"
              name="message"
              placeholder="Paste your email content here..."
              spellcheck="false"
            ></textarea>
            <span class="char-hint">Enter email text to classify</span>
          </div>
          <div class="btn-row">
            <button type="submit" class="btn-predict">
              <i class="fa-solid fa-magnifying-glass"></i> Predict
            </button>
            <button type="button" id="clear-button" class="btn-clear">
              <i class="fa-solid fa-xmark"></i> Clear
            </button>
          </div>
        </form>
      </div>
    </main>

    <!-- ======================== RESULT MODAL ======================== -->
    <div id="modal-overlay" class="modal-overlay hidden">
      <div id="result-modal" class="result-modal">
        <!-- Drag handle -->
        <div id="modal-drag-handle" class="modal-drag-handle">
          <span class="drag-dots">
            <i class="fa-solid fa-grip-lines"></i>
          </span>
          <button id="modal-close" class="modal-close-btn" title="Close">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>

        <!-- Content -->
        <div class="modal-body">
          <div class="modal-icon-wrap" id="modal-icon">
            <!-- injected by JS -->
          </div>
          <p class="modal-tag">Classification Result</p>
          <div class="modal-verdict" id="modal-verdict">
            <!-- injected by JS -->
          </div>
          <div class="modal-divider" id="modal-divider"></div>
          <p class="modal-desc" id="modal-desc">
            <!-- injected by JS -->
          </p>
          <div class="modal-actions">
            <button id="modal-classify-again" class="modal-btn-primary">
              <i class="fa-solid fa-rotate-left"></i> Classify Another
            </button>
            <a href="/logout" class="modal-btn-secondary">
              <i class="fa-solid fa-right-from-bracket"></i> Log Out
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading spinner overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
      <div class="spinner"></div>
      <p>Analysing email...</p>
    </div>

    <!-- ======================== SCRIPTS ======================== -->
    <script>
      // ---- Theme (runs before paint to avoid flicker) ----
      (function () {
        if (localStorage.getItem("SpamShield-theme") === "light") {
          document.body.classList.add("light-mode");
        }
      })();
    </script>

    <script>
      // ---- Theme toggle ----
      document
        .getElementById("theme-toggle")
        .addEventListener("click", function () {
          const isLight = document.body.classList.toggle("light-mode");
          localStorage.setItem("SpamShield-theme", isLight ? "light" : "dark");
        });

      // ---- Clear button ----
      document
        .getElementById("clear-button")
        .addEventListener("click", function () {
          document.getElementById("message").value = "";
          document.getElementById("message").focus();
        });

      // ---- Form submit → fetch → show modal ----
      document
        .getElementById("prediction-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const message = document.getElementById("message").value.trim();
          if (!message) {
            document.getElementById("message").focus();
            document.getElementById("message").style.borderColor =
              "var(--danger)";
            setTimeout(
              () => (document.getElementById("message").style.borderColor = ""),
              1500,
            );
            return;
          }

          // Show loading
          document.getElementById("loading-overlay").classList.remove("hidden");

          try {
            const formData = new FormData();
            formData.append("message", message);

            const response = await fetch("/predict", {
              method: "POST",
              body: formData,
            });

            const text = await response.text();

            // Parse prediction from returned HTML
            // result.html contains: {{ prediction }} as text
            let prediction = "unknown";
            const parser = new DOMParser();
            const doc = parser.parseFromString(text, "text/html");

            // Try to extract from result.html body data attribute
            const resultData = doc.querySelector("[data-prediction]");
            if (resultData) {
              prediction = resultData.dataset.prediction.trim().toLowerCase();
            } else {
              // Fallback: search for "spam" or "ham" / "not spam" in returned text
              const bodyText = doc.body
                ? doc.body.innerText.toLowerCase()
                : text.toLowerCase();
              if (bodyText.includes("not spam") || bodyText.includes("ham")) {
                prediction = "ham";
              } else if (bodyText.includes("spam")) {
                prediction = "spam";
              }
            }

            showResultModal(prediction);
          } catch (err) {
            console.error(err);
          } finally {
            document.getElementById("loading-overlay").classList.add("hidden");
          }
        });

      function showResultModal(prediction) {
        const isSpam = prediction === "spam";

        const iconWrap = document.getElementById("modal-icon");
        const verdict = document.getElementById("modal-verdict");
        const desc = document.getElementById("modal-desc");
        const modal = document.getElementById("result-modal");
        const overlay = document.getElementById("modal-overlay");

        // Reset spam/ham class
        modal.classList.remove("modal-spam", "modal-ham");
        modal.classList.add(isSpam ? "modal-spam" : "modal-ham");

        // Use FA6 free-tier icons only
        if (isSpam) {
          iconWrap.innerHTML = '<i class="fa-solid fa-circle-xmark"></i>';
          iconWrap.className = "modal-icon-wrap icon-spam";
          verdict.textContent = "SPAM";
          verdict.className = "modal-verdict verdict-spam";
          desc.innerHTML =
            "This email has been flagged as <strong>spam</strong>.<br>Avoid clicking links or sharing personal information.";
        } else {
          iconWrap.innerHTML = '<i class="fa-solid fa-circle-check"></i>';
          iconWrap.className = "modal-icon-wrap icon-ham";
          verdict.textContent = "NOT SPAM";
          verdict.className = "modal-verdict verdict-ham";
          desc.innerHTML =
            "This email appears to be <strong>legitimate</strong>.<br>It passed our spam classification check.";
        }

        // ---- Snap to center WITHOUT transition to avoid jump ----
        // 1. Kill transition + any leftover drag positioning
        modal.style.transition = "none";
        modal.style.left = "";
        modal.style.top = "";
        modal.style.transform = "translate(-50%, -50%)";
        modal.classList.remove("modal-visible");

        overlay.classList.remove("hidden");

        // 2. Two rAFs: first lets the browser apply the "reset" above, second re-enables transition & opens
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            modal.style.transition = "";
            overlay.classList.add("visible");
            modal.classList.add("modal-visible");
          });
        });
      }

      // ---- Close modal ----
      function closeModal() {
        const overlay = document.getElementById("modal-overlay");
        const modal = document.getElementById("result-modal");
        overlay.classList.remove("visible");
        modal.classList.remove("modal-visible");
        setTimeout(() => overlay.classList.add("hidden"), 300);
      }

      document
        .getElementById("modal-close")
        .addEventListener("click", closeModal);
      document
        .getElementById("modal-overlay")
        .addEventListener("click", function (e) {
          if (e.target === this) closeModal();
        });

      document
        .getElementById("modal-classify-again")
        .addEventListener("click", function () {
          closeModal();
          document.getElementById("message").value = "";
          setTimeout(() => document.getElementById("message").focus(), 350);
        });

      // ---- Draggable modal ----
      (function () {
        const handle = document.getElementById("modal-drag-handle");
        const modal = document.getElementById("result-modal");
        let dragging = false,
          startX,
          startY,
          origLeft,
          origTop;

        function startDrag(clientX, clientY) {
          dragging = true;

          const rect = modal.getBoundingClientRect();

          // CRITICAL: disable CSS transition BEFORE changing transform/left/top
          // otherwise the browser animates from centered-transform to top-left position
          modal.style.transition = "none";
          modal.style.transform = "none";
          modal.style.left = rect.left + "px";
          modal.style.top = rect.top + "px";

          startX = clientX;
          startY = clientY;
          origLeft = rect.left;
          origTop = rect.top;

          handle.style.cursor = "grabbing";
          document.body.style.userSelect = "none";
        }

        function moveDrag(clientX, clientY) {
          if (!dragging) return;
          modal.style.left = origLeft + clientX - startX + "px";
          modal.style.top = origTop + clientY - startY + "px";
        }

        function endDrag() {
          if (!dragging) return;
          dragging = false;
          handle.style.cursor = "grab";
          document.body.style.userSelect = "";
        }

        // Mouse
        handle.addEventListener("mousedown", function (e) {
          if (e.target.closest(".modal-close-btn")) return;
          e.preventDefault();
          startDrag(e.clientX, e.clientY);
        });
        document.addEventListener("mousemove", function (e) {
          moveDrag(e.clientX, e.clientY);
        });
        document.addEventListener("mouseup", endDrag);

        // Touch
        handle.addEventListener(
          "touchstart",
          function (e) {
            if (e.target.closest(".modal-close-btn")) return;
            const t = e.touches[0];
            startDrag(t.clientX, t.clientY);
          },
          { passive: true },
        );
        document.addEventListener(
          "touchmove",
          function (e) {
            if (!dragging) return;
            const t = e.touches[0];
            moveDrag(t.clientX, t.clientY);
          },
          { passive: true },
        );
        document.addEventListener("touchend", endDrag);
      })();
    </script>
  </body>
</html>
